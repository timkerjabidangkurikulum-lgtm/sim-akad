import React, { useState } from 'react';
import { 
  BookOpen, 
  GraduationCap, 
  BrainCircuit, 
  FileText, 
  CheckCircle, 
  Table, 
  Settings, 
  Download, 
  RefreshCw,
  Copy,
  Printer,
  ChevronRight,
  Sparkles,
  AlertCircle,
  Loader2,
  Library,
  ScrollText,
  Heart,
  Globe, // Simbol Deep Learning (Global Competencies)
  Award // Simbol Kualitas/Prestasi
} from 'lucide-react';

// --- API Configuration ---
const apiKey = ""; // API Key akan disuntikkan oleh runtime environment

// --- Helper: Retry Logic for API Calls ---
const fetchWithRetry = async (url, options, retries = 3, backoff = 1000) => {
  try {
    const response = await fetch(url, options);
    if (!response.ok) {
      if (retries > 0 && (response.status === 429 || response.status >= 500)) {
        await new Promise(resolve => setTimeout(resolve, backoff));
        return fetchWithRetry(url, options, retries - 1, backoff * 2);
      }
      throw new Error(`API Error: ${response.statusText}`);
    }
    return response.json();
  } catch (error) {
    if (retries > 0) {
      await new Promise(resolve => setTimeout(resolve, backoff));
      return fetchWithRetry(url, options, retries - 1, backoff * 2);
    }
    throw error;
  }
};

// --- Komponen UI Sederhana ---
const Card = ({ children, className = "" }) => (
  <div className={`bg-white rounded-xl border border-gray-200 shadow-sm ${className}`}>
    {children}
  </div>
);

const Badge = ({ children, type = "default" }) => {
  const styles = {
    default: "bg-gray-100 text-gray-700",
    success: "bg-emerald-100 text-emerald-700", // Hijau Kemenag
    warning: "bg-yellow-100 text-yellow-800", // Emas
    danger: "bg-red-100 text-red-700",
    blue: "bg-blue-100 text-blue-700",
    primary: "bg-teal-100 text-teal-800", // Teal Kemenag
  };
  return (
    <span className={`px-2.5 py-0.5 rounded-full text-xs font-medium ${styles[type] || styles.default}`}>
      {children}
    </span>
  );
};

// --- Data Referensi Kurikulum (KMA 183 & KMA 1503 + Deep Learning) ---
const REFERENCE_DATA = {
  subjects: [
    // Mapel PAI & Bahasa Arab (KMA 183)
    "Al-Qur'an Hadis",
    "Akidah Akhlak",
    "Fikih",
    "Sejarah Kebudayaan Islam (SKI)",
    "Bahasa Arab",
    // Mapel Umum
    "Bahasa Indonesia", 
    "Matematika", 
    "IPA (Fisika/Kimia/Biologi)", 
    "IPS (Sejarah/Geografi/Ekonomi/Sosiologi)",
    "Pendidikan Pancasila", 
    "Bahasa Inggris", 
    "Informatika", 
    "PJOK", 
    "Seni Budaya",
    "Prakarya"
  ],
  phases: [
    { id: "Fase A", label: "Fase A (Kelas 1-2 MI)", classes: ["Kelas 1", "Kelas 2"] },
    { id: "Fase B", label: "Fase B (Kelas 3-4 MI)", classes: ["Kelas 3", "Kelas 4"] },
    { id: "Fase C", label: "Fase C (Kelas 5-6 MI)", classes: ["Kelas 5", "Kelas 6"] },
    { id: "Fase D", label: "Fase D (Kelas 7-9 MTs)", classes: ["Kelas 7", "Kelas 8", "Kelas 9"] },
    { id: "Fase E", label: "Fase E (Kelas 10 MA)", classes: ["Kelas 10"] },
    { id: "Fase F", label: "Fase F (Kelas 11-12 MA)", classes: ["Kelas 11", "Kelas 12"] },
  ],
  types: [
    { id: 'Pilihan Ganda', label: 'Pilihan Ganda (PG)' },
    { id: 'Pilihan Ganda Kompleks', label: 'PG Kompleks' },
    { id: 'Benar - Salah', label: 'Benar - Salah' },
    { id: 'Menjodohkan', label: 'Menjodohkan' },
    { id: 'Uraian Singkat', label: 'Isian/Uraian Singkat' },
    { id: 'Essai', label: 'Uraian Bebas (Essai)' },
  ],
  assessments: [
    { id: 'Formatif', label: 'Formatif (Diagnostik/Proses)' },
    { id: 'Sumatif Lingkup Materi', label: 'Sumatif Lingkup Materi' },
    { id: 'Sumatif Akhir Semester', label: 'Sumatif Akhir Semester (SAS/PAS)' }
  ]
};

export default function App() {
  const [step, setStep] = useState(1); // 1: Input, 2: Loading, 3: Result
  const [activeTab, setActiveTab] = useState('soal'); // soal, kunci, kisi
  const [errorMsg, setErrorMsg] = useState('');
  
  const [formData, setFormData] = useState({
    subject: '',
    phase: '',
    classLevel: '',
    assessmentType: 'Sumatif Lingkup Materi',
    topic: '',
    type: 'Pilihan Ganda',
    easy: 2,
    medium: 2,
    hard: 1,
  });

  const [generatedData, setGeneratedData] = useState([]);

  // Handle Phase Change to reset Class
  const handlePhaseChange = (e) => {
    const selectedPhase = e.target.value;
    setFormData({
      ...formData,
      phase: selectedPhase,
      classLevel: '' 
    });
  };

  const getAvailableClasses = () => {
    const phaseData = REFERENCE_DATA.phases.find(p => p.id === formData.phase);
    return phaseData ? phaseData.classes : [];
  };

  // Fungsi memanggil Gemini API
  const generateQuestionsWithAI = async () => {
    setErrorMsg('');
    if (!formData.subject || !formData.phase || !formData.classLevel || !formData.topic) {
      alert("Mohon lengkapi Mata Pelajaran, Fase, Kelas, dan Materi Pokok.");
      return;
    }

    setStep(2);

    const totalSoal = (parseInt(formData.easy) || 0) + (parseInt(formData.medium) || 0) + (parseInt(formData.hard) || 0);
    
    // --- PROMPT ENGINEERING: INTEGRASI DEEP LEARNING & KMA 1503 ---
    const systemInstruction = `
      Anda adalah "Sobat Madrasah AI", ahli asesmen pendidikan Kemenag RI. 
      Filosofi anda menggabungkan dua pilar utama:
      1. **Kurikulum Berbasis Cinta (KMA 1503 Th 2025):** Menekankan dimensi Mahabbah (Cinta Tuhan, Cinta Ilmu, Cinta Sesama, Cinta Alam, Cinta Diri).
      2. **Deep Learning (Pembelajaran Mendalam):** Mengukur 6 Kompetensi Global (6C): *Character, Citizenship, Collaboration, Communication, Creativity, Critical Thinking*.

      Tugas: Susun soal yang valid secara akademik (KMA 183 untuk PAI), namun dikemas dengan narasi yang menumbuhkan karakter (Deep Learning) dan kasih sayang (Cinta).
    `;
    
    const userPrompt = `
      Buatkan ${totalSoal} butir soal untuk Madrasah.

      KONTEKS IMPLEMENTASI:
      - Mapel: ${formData.subject}
      - Jenjang: ${formData.phase} - ${formData.classLevel}
      - Materi Pokok: "${formData.topic}"
      - Jenis Asesmen: ${formData.assessmentType}
      
      SPESIFIKASI SOAL:
      1. Tipe Soal: ${formData.type}
      2. Sebaran Kognitif:
         - L1 (Pemahaman): ${formData.easy}
         - L2 (Penerapan): ${formData.medium}
         - L3 (Penalaran/Deep Learning): ${formData.hard}
      
      PERSYARATAN WAJIB (STRICT):
      1. **OPSI JAWABAN:** Jika tipe soal adalah Pilihan Ganda, WAJIB menyertakan 5 OPSI JAWABAN (A, B, C, D, E).
      2. **STIMULUS DEEP LEARNING:** Setiap soal (terutama L2 & L3) WAJIB diawali stimulus. Stimulus harus relevan dengan kehidupan nyata (Citizenship), memecahkan masalah (Critical Thinking), atau inspiratif (Character).
      3. **SENTUHAN CINTA:** Gunakan bahasa yang santun, inklusif, dan tidak menghakimi. Hindari konten negatif.
      4. **DIMENSI:** Tentukan Dimensi Cinta (KMA 1503) dan Kompetensi 6C yang relevan untuk setiap soal di kisi-kisi.
      5. **FORMAT OUTPUT:** JSON Array murni.
      
      Struktur JSON Object:
      {
        "no": number,
        "type": "${formData.type}",
        "difficulty": "L1" | "L2" | "L3 (Deep Learning)",
        "content": {
          "stimulus": "Teks stimulus yang kontekstual/inspiratif...",
          "question": "Pertanyaan inti...",
          "options": ["Teks Opsi A", "Teks Opsi B", "Teks Opsi C", "Teks Opsi D", "Teks Opsi E"] (Array berisi 5 string. Pastikan ada 5 item jika PG. Null jika essai)
        },
        "key": "Kunci Jawaban",
        "explanation": "Pembahasan",
        "grid": {
          "competency": "TP (Tujuan Pembelajaran)",
          "indicator": "Indikator Soal",
          "dimension": "Dimensi Cinta (Misal: Cinta Alam) & 6C (Misal: Critical Thinking)"
        }
      }
    `;

    try {
      const response = await fetchWithRetry(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: userPrompt }] }],
            systemInstruction: { parts: [{ text: systemInstruction }] },
            generationConfig: {
              responseMimeType: "application/json"
            }
          })
        }
      );

      const data = response;
      const textResponse = data.candidates?.[0]?.content?.parts?.[0]?.text;
      
      if (textResponse) {
        const parsedData = JSON.parse(textResponse);
        setGeneratedData(parsedData);
        setStep(3);
      } else {
        throw new Error("Tidak ada respons dari AI.");
      }
    } catch (err) {
      console.error("Gagal generate:", err);
      setErrorMsg("Gagal menyusun soal. Periksa koneksi internet Anda.");
      setStep(1);
    }
  };

  const handleReset = () => {
    setStep(1);
    setGeneratedData([]);
    setActiveTab('soal');
    setErrorMsg('');
  };

  // --- LOGIKA GENERATOR WORD YANG DISESUAIKAN (TABEL LAYOUT PRESISI) ---
  const handleDownloadDoc = () => {
    if (generatedData.length === 0) return;

    const content = `
      <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
      <head>
        <meta charset='utf-8'>
        <title>Sobat Madrasah - ${formData.subject}</title>
        <style>
          @page { size: A4; margin: 2.54cm; }
          body { font-family: 'Times New Roman', serif; font-size: 12pt; line-height: 1.15; color: #000; }
          p { margin: 0 0 6pt 0; text-align: justify; text-indent: 1.25cm; }
          .no-indent { text-indent: 0; }
          
          /* HEADER TABLE (KOP SURAT) */
          .header-table { width: 100%; border-bottom: 3px double #000; margin-bottom: 20px; }
          .header-table td { border: none; padding: 5px; vertical-align: middle; }
          .header-table p { text-indent: 0; text-align: center; }
          
          /* IDENTITY TABLE */
          .identity-table { width: 100%; border: none; margin-bottom: 20px; font-size: 11pt; }
          .identity-table td { border: none; padding: 2px 5px; vertical-align: top; }
          
          /* CONTENT TABLES */
          .content-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 11pt; }
          .content-table th, .content-table td { border: 1px solid #000; padding: 5px; vertical-align: top; }
          .content-table th { background: none; text-align: center; font-weight: bold; }
          
          /* QUESTION ITEM TABLE (Agar Rapi per Nomor) */
          .question-item-table { width: 100%; border: none; margin-bottom: 15px; page-break-inside: avoid; }
          .question-item-table td { border: none; padding: 2px; vertical-align: top; }
          
          .stimulus-box { 
            border: 1px solid #000; 
            padding: 8px; 
            background: none; 
            margin-bottom: 8px; 
            font-style: italic; 
            font-size: 11pt;
          }
          
          h1 { font-size: 12pt; text-transform: uppercase; margin: 0; text-align: center; color: #000; }
          h2 { font-size: 12pt; text-transform: uppercase; margin: 4pt 0 0 0; text-align: center; color: #000; }
          h3 { font-size: 12pt; margin: 12pt 0 6pt 0; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid #000; padding-bottom: 4pt; color: #000; }
          
          .page-break { page-break-before: always; }
          .tag-dimensi { font-size: 9pt; color: #000; font-style: italic; }
        </style>
      </head>
      <body>
        
        <!-- HEADER / KOP -->
        <table class="header-table">
          <tr>
            <td width="100%" align="center">
              <h1>KEMENTERIAN AGAMA REPUBLIK INDONESIA</h1>
              <h2>INSTRUMEN ASESMEN MADRASAH</h2>
              <p style="margin:0; font-size:10pt;">${formData.assessmentType.toUpperCase()}</p>
            </td>
          </tr>
        </table>

        <!-- IDENTITAS -->
        <table class="identity-table">
          <tr>
            <td width="20%"><strong>Mata Pelajaran</strong></td>
            <td width="2%">:</td>
            <td width="48%">${formData.subject}</td>
            <td width="15%"><strong>Fase/Kelas</strong></td>
            <td width="2%">:</td>
            <td width="13%">${formData.phase}</td>
          </tr>
          <tr>
            <td><strong>Materi Pokok</strong></td>
            <td>:</td>
            <td colspan="4">${formData.topic}</td>
          </tr>
        </table>

        <!-- BAGIAN A: SOAL -->
        <h3>A. SOAL DAN STIMULUS</h3>
        
        ${generatedData.map(item => `
          <table class="question-item-table">
            <tr>
              <td width="5%" valign="top"><strong>${item.no}.</strong></td>
              <td width="95%" valign="top">
                ${item.content.stimulus ? `<div class="stimulus-box">${item.content.stimulus.replace(/\n/g, '<br/>')}</div>` : ''}
                <div style="margin-bottom: 10px;">${item.content.question.replace(/\n/g, '<br/>')}</div>
                
                ${item.content.options && item.content.options.length > 0 ? `
                  <table style="width:100%; border:none; border-collapse: collapse;">
                    ${item.content.options.map((opt, idx) => {
                       // Hapus prefix A. B. C. jika AI sudah menambahkannya agar tidak double
                       const cleanOpt = opt.replace(/^[A-E]\.\s*/i, ''); 
                       const label = String.fromCharCode(65 + idx); // A, B, C...
                       return `
                        <tr>
                          <td style="border:none; padding:4px; vertical-align:top;" width="30"><strong>${label}.</strong></td>
                          <td style="border:none; padding:4px; vertical-align:top;">${cleanOpt}</td>
                        </tr>
                       `;
                    }).join('')}
                  </table>
                ` : ''}
              </td>
            </tr>
          </table>
        `).join('')}

        <div class="page-break"></div>

        <!-- BAGIAN B: KISI-KISI -->
        <h3>B. KISI-KISI & INTEGRASI NILAI (Deep Learning)</h3>
        <table class="content-table">
          <thead>
            <tr>
              <th width="5%">No</th>
              <th width="30%">Tujuan Pembelajaran</th>
              <th width="40%">Indikator & Dimensi</th>
              <th width="10%">Level</th>
              <th width="15%">Bentuk</th>
            </tr>
          </thead>
          <tbody>
            ${generatedData.map(item => `
              <tr>
                <td align="center">${item.no}</td>
                <td>${item.grid.competency}</td>
                <td>
                  ${item.grid.indicator}<br/>
                  <span class="tag-dimensi">[${item.grid.dimension}]</span>
                </td>
                <td align="center">${item.difficulty.replace('Deep Learning', 'DL')}</td>
                <td align="center">${item.type}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>

        <div class="page-break"></div>

        <!-- BAGIAN C: KUNCI -->
        <h3>C. KUNCI JAWABAN & PEMBAHASAN</h3>
        <table class="content-table">
          <thead>
            <tr>
              <th width="5%">No</th>
              <th width="25%">Kunci Jawaban</th>
              <th width="70%">Pembahasan</th>
            </tr>
          </thead>
          <tbody>
            ${generatedData.map(item => `
              <tr>
                <td align="center"><strong>${item.no}</strong></td>
                <td>${item.key}</td>
                <td>${item.explanation}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>

      </body>
      </html>
    `;

    const blob = new Blob(['\ufeff', content], { type: 'application/msword' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    const safeSubject = formData.subject.replace(/[^a-z0-9]/gi, '_').toLowerCase();
    link.download = `SobatMadrasah_${safeSubject}_${new Date().getTime()}.doc`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const getTotalQuestions = () => {
    return (parseInt(formData.easy) || 0) + (parseInt(formData.medium) || 0) + (parseInt(formData.hard) || 0);
  };

  return (
    <div className="min-h-screen bg-teal-50/40 font-sans text-slate-800">
      {/* Header */}
      <header className="bg-white border-b border-teal-100 sticky top-0 z-30 shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
          <div className="flex items-center gap-3 text-teal-800">
            <div className="bg-teal-700 text-white p-1.5 rounded-lg shadow-sm">
              <GraduationCap className="w-6 h-6" />
            </div>
            <div className="flex flex-col">
              <h1 className="text-xl font-bold tracking-tight leading-none text-teal-900">Sobat Madrasah AI</h1>
              <span className="text-[10px] text-teal-600 font-medium tracking-wide">Asisten Cerdas Guru Madrasah</span>
            </div>
          </div>
          <div className="hidden sm:flex items-center gap-4 text-sm text-slate-500">
            <div className="flex flex-col items-end text-xs">
              <span className="font-semibold text-teal-700 flex items-center gap-1">
                <Heart className="w-3 h-3 text-teal-600" /> KMA 1503
              </span>
              <span className="flex items-center gap-1">
                <Globe className="w-3 h-3 text-teal-600" /> Deep Learning
              </span>
            </div>
            <div className="w-9 h-9 bg-gradient-to-tr from-teal-600 to-emerald-500 text-white rounded-xl flex items-center justify-center font-bold shadow-md ring-2 ring-teal-50">
              SM
            </div>
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        {/* Error Message */}
        {errorMsg && (
          <div className="mb-6 bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-xl flex items-center gap-3">
            <AlertCircle className="w-5 h-5" />
            {errorMsg}
          </div>
        )}

        {/* VIEW 1: FORM INPUT */}
        {step === 1 && (
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
            {/* Left Column: Form */}
            <div className="lg:col-span-2 space-y-6">
              <div className="bg-white rounded-2xl p-6 shadow-sm border border-teal-100 relative overflow-hidden">
                <div className="absolute top-0 right-0 w-24 h-24 bg-teal-50 rounded-bl-full -mr-4 -mt-4 opacity-50"></div>
                
                <div className="flex items-center gap-3 mb-6 border-b border-teal-50 pb-4 relative z-10">
                  <div className="p-2 bg-teal-100 rounded-lg text-teal-700">
                    <Settings className="w-5 h-5" />
                  </div>
                  <div>
                    <h2 className="text-lg font-bold text-teal-900">Perancangan Asesmen</h2>
                    <p className="text-xs text-slate-500">
                      Integrasi <strong>Deep Learning (6C)</strong> & <strong>Kurikulum Berbasis Cinta</strong>
                    </p>
                  </div>
                </div>

                <div className="space-y-5 relative z-10">
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-5">
                    {/* Mata Pelajaran */}
                    <div className="sm:col-span-2">
                      <label className="block text-sm font-medium text-slate-700 mb-1">Mata Pelajaran</label>
                      <input 
                        list="subjects"
                        className="w-full rounded-lg border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 py-2.5 px-3 bg-slate-50 transition-all hover:bg-white"
                        value={formData.subject}
                        onChange={(e) => setFormData({...formData, subject: e.target.value})}
                        placeholder="Contoh: Akidah Akhlak, Matematika, IPS..."
                      />
                      <datalist id="subjects">
                        {REFERENCE_DATA.subjects.map(s => <option key={s} value={s} />)}
                      </datalist>
                    </div>

                    {/* FASE */}
                    <div>
                      <label className="block text-sm font-medium text-slate-700 mb-1">Fase (Jenjang)</label>
                      <select 
                        className="w-full rounded-lg border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 py-2.5 px-3 bg-slate-50 transition-all hover:bg-white"
                        value={formData.phase}
                        onChange={handlePhaseChange}
                      >
                        <option value="">Pilih Fase...</option>
                        {REFERENCE_DATA.phases.map(p => <option key={p.id} value={p.id}>{p.label}</option>)}
                      </select>
                    </div>

                    {/* KELAS SPESIFIK */}
                    <div>
                      <label className="block text-sm font-medium text-slate-700 mb-1">Kelas</label>
                      <select 
                        className="w-full rounded-lg border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 py-2.5 px-3 bg-slate-50 disabled:bg-slate-100 transition-all hover:bg-white"
                        value={formData.classLevel}
                        onChange={(e) => setFormData({...formData, classLevel: e.target.value})}
                        disabled={!formData.phase}
                      >
                        <option value="">{formData.phase ? "Pilih Kelas..." : "-"}</option>
                        {getAvailableClasses().map(c => <option key={c} value={c}>{c}</option>)}
                      </select>
                    </div>

                    {/* JENIS ASESMEN */}
                    <div className="sm:col-span-2">
                      <label className="block text-sm font-medium text-slate-700 mb-1">Jenis Asesmen</label>
                      <div className="grid grid-cols-1 sm:grid-cols-3 gap-2">
                        {REFERENCE_DATA.assessments.map((a) => (
                          <button
                            key={a.id}
                            onClick={() => setFormData({...formData, assessmentType: a.id})}
                            className={`p-2 text-xs font-medium rounded-lg border text-center transition-all ${
                              formData.assessmentType === a.id 
                                ? 'border-teal-600 bg-teal-50 text-teal-800 ring-1 ring-teal-600' 
                                : 'border-slate-200 hover:border-slate-300 text-slate-600 bg-white hover:bg-slate-50'
                            }`}
                          >
                            {a.id}
                          </button>
                        ))}
                      </div>
                    </div>
                  </div>

                  {/* TOPIK / MATERI */}
                  <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1">Materi Pokok (KMA 183)</label>
                    <textarea 
                      rows={3}
                      className="w-full rounded-lg border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 py-3 px-3 bg-slate-50 text-sm transition-all hover:bg-white"
                      placeholder="Contoh: Mengamalkan Adab Bertetangga (Cinta Sesama) ATAU Pelestarian Lingkungan (Cinta Alam)"
                      value={formData.topic}
                      onChange={(e) => setFormData({...formData, topic: e.target.value})}
                    />
                  </div>

                  {/* TIPE & KESULITAN */}
                  <div className="border-t border-slate-100 pt-5">
                    <div className="flex justify-between items-center mb-3">
                      <label className="block text-sm font-medium text-slate-700">Proporsi Kognitif & Deep Learning</label>
                      <span className="text-xs text-teal-600 bg-teal-50 px-2 py-0.5 rounded font-bold">Total: {getTotalQuestions()} Butir</span>
                    </div>
                    
                    <div className="mb-4">
                      <select 
                         className="w-full rounded-lg border-slate-300 shadow-sm focus:border-teal-500 py-2 px-3 text-sm bg-white"
                         value={formData.type}
                         onChange={(e) => setFormData({...formData, type: e.target.value})}
                      >
                        {REFERENCE_DATA.types.map(t => <option key={t.id} value={t.id}>{t.label}</option>)}
                      </select>
                    </div>

                    <div className="bg-slate-50 rounded-xl p-4 border border-slate-200 grid grid-cols-3 gap-4">
                      <div className="text-center">
                        <label className="block text-[10px] font-bold text-slate-500 mb-1 uppercase tracking-wide">Level 1</label>
                        <input 
                          type="number" min="0" max="20"
                          className="w-full text-center rounded-lg border-slate-300 focus:border-teal-500 focus:ring-teal-500"
                          value={formData.easy}
                          onChange={(e) => setFormData({...formData, easy: e.target.value})}
                        />
                        <span className="text-[10px] text-slate-400">Pemahaman</span>
                      </div>
                      <div className="text-center">
                        <label className="block text-[10px] font-bold text-slate-500 mb-1 uppercase tracking-wide">Level 2</label>
                        <input 
                          type="number" min="0" max="20"
                          className="w-full text-center rounded-lg border-slate-300 focus:border-yellow-500 focus:ring-yellow-500"
                          value={formData.medium}
                          onChange={(e) => setFormData({...formData, medium: e.target.value})}
                        />
                        <span className="text-[10px] text-slate-400">Penerapan</span>
                      </div>
                      <div className="text-center">
                        <label className="block text-[10px] font-bold text-slate-500 mb-1 uppercase tracking-wide">Level 3</label>
                        <input 
                          type="number" min="0" max="20"
                          className="w-full text-center rounded-lg border-slate-300 focus:border-red-500 focus:ring-red-500"
                          value={formData.hard}
                          onChange={(e) => setFormData({...formData, hard: e.target.value})}
                        />
                        <span className="text-[10px] text-slate-400">Deep Learning</span>
                      </div>
                    </div>
                  </div>

                  <div className="mt-8">
                    <button 
                      onClick={generateQuestionsWithAI}
                      disabled={getTotalQuestions() === 0}
                      className="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-teal-600 to-emerald-600 hover:from-teal-700 hover:to-emerald-700 disabled:from-slate-300 disabled:to-slate-300 disabled:cursor-not-allowed text-white font-bold py-3 px-4 rounded-xl shadow-lg shadow-teal-200 transition-all hover:scale-[1.01]"
                    >
                      <Sparkles className="w-5 h-5" />
                      Buat Asesmen Madrasah
                    </button>
                  </div>
                </div>
              </div>
            </div>

            {/* Right Column: Pedagogical Info */}
            <div className="space-y-6">
              {/* Kartu Integrasi KMA */}
              <div className="bg-gradient-to-br from-teal-700 to-emerald-800 rounded-2xl p-6 text-white shadow-xl relative overflow-hidden">
                <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl -mr-10 -mt-10"></div>
                <h3 className="font-bold text-md mb-3 relative z-10 flex items-center gap-2 border-b border-teal-500 pb-2">
                  <Award className="w-5 h-5" />
                  Keunggulan Sobat Madrasah
                </h3>
                <div className="space-y-4 text-xs relative z-10">
                  <div className="flex gap-2">
                    <Heart className="w-4 h-4 shrink-0 text-emerald-300" />
                    <div>
                      <strong className="text-emerald-100 block mb-1">Kurikulum Berbasis Cinta (KMA 1503):</strong>
                      Pendidikan yang memanusiakan, berbasis kasih sayang dan keadaban.
                    </div>
                  </div>
                  <div className="flex gap-2">
                    <Globe className="w-4 h-4 shrink-0 text-emerald-300" />
                    <div>
                      <strong className="text-emerald-100 block mb-1">Deep Learning (6C):</strong>
                      Membangun karakter, kewarganegaraan, berpikir kritis, komunikasi, kolaborasi, dan kreativitas.
                    </div>
                  </div>
                </div>
              </div>

              <Card className="p-5 bg-white border-teal-100 shadow-sm">
                <h4 className="font-semibold text-teal-900 mb-2 flex items-center gap-2 text-sm">
                  <Library className="w-4 h-4" />
                  Tips Soal Deep Learning
                </h4>
                <p className="text-xs text-slate-600 leading-relaxed">
                  Soal Deep Learning menghubungkan materi dengan <strong>kehidupan nyata (Citizenship)</strong>.
                </p>
                <div className="mt-2 text-xs bg-teal-50 p-3 rounded text-teal-800 italic border border-teal-100">
                  "Daripada sekadar menghitung zakat, ajak siswa menganalisis bagaimana zakat profesi dapat mengurangi kesenjangan ekonomi di lingkungan sekitar."
                </div>
              </Card>
            </div>
          </div>
        )}

        {/* VIEW 2: LOADING */}
        {step === 2 && (
          <div className="flex flex-col items-center justify-center py-24 px-4 text-center">
            <div className="relative mb-8">
              <div className="absolute inset-0 bg-teal-200 rounded-full blur-xl opacity-50 animate-pulse"></div>
              <div className="relative bg-white p-4 rounded-2xl shadow-lg border border-teal-100">
                <Loader2 className="w-10 h-10 text-teal-600 animate-spin" />
              </div>
            </div>
            <h2 className="text-2xl font-bold text-teal-900 mb-2">Sobat Madrasah Bekerja...</h2>
            <p className="text-slate-500 max-w-md mx-auto text-sm">
              Meramu soal dengan sentuhan <span className="text-teal-700 font-semibold">Deep Learning</span> dan <span className="text-teal-700 font-semibold">Cinta</span> untuk siswa Madrasah.
            </p>
          </div>
        )}

        {/* VIEW 3: RESULT */}
        {step === 3 && (
          <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 gap-4">
              <div>
                <h2 className="text-2xl font-bold text-slate-900 flex items-center gap-2">
                  Asesmen Siap
                  <Badge type="primary">Dokumen Presisi</Badge>
                </h2>
                <p className="text-sm text-slate-500 mt-1 flex items-center gap-2">
                  <span className="font-semibold text-teal-700">{formData.assessmentType}</span> â€¢ {formData.subject}
                </p>
              </div>
              <div className="flex gap-2 w-full sm:w-auto">
                <button 
                  onClick={handleReset}
                  className="flex-1 sm:flex-none flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors"
                >
                  <RefreshCw className="w-4 h-4" />
                  Buat Baru
                </button>
                <button 
                  onClick={handleDownloadDoc} 
                  className="flex-1 sm:flex-none flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium text-white bg-teal-700 hover:bg-teal-800 rounded-lg shadow-sm transition-colors"
                >
                  <Download className="w-4 h-4" />
                  Download Word (Rapi)
                </button>
              </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
              {/* Sidebar Navigation Results */}
              <div className="lg:col-span-1 space-y-2 sticky top-24 h-fit">
                <button 
                  onClick={() => setActiveTab('soal')}
                  className={`w-full flex items-center justify-between px-4 py-3 rounded-lg text-sm font-medium transition-colors ${activeTab === 'soal' ? 'bg-white text-teal-800 shadow-sm border border-teal-100 ring-1 ring-teal-200' : 'text-slate-600 hover:bg-white/50 hover:text-slate-900'}`}
                >
                  <span className="flex items-center gap-3">
                    <FileText className="w-4 h-4" /> Butir Soal
                  </span>
                  <ChevronRight className={`w-4 h-4 transition-transform ${activeTab === 'soal' ? 'rotate-90' : ''}`} />
                </button>
                <button 
                  onClick={() => setActiveTab('kunci')}
                  className={`w-full flex items-center justify-between px-4 py-3 rounded-lg text-sm font-medium transition-colors ${activeTab === 'kunci' ? 'bg-white text-teal-800 shadow-sm border border-teal-100 ring-1 ring-teal-200' : 'text-slate-600 hover:bg-white/50 hover:text-slate-900'}`}
                >
                  <span className="flex items-center gap-3">
                    <CheckCircle className="w-4 h-4" /> Kunci & Skor
                  </span>
                  <ChevronRight className={`w-4 h-4 transition-transform ${activeTab === 'kunci' ? 'rotate-90' : ''}`} />
                </button>
                <button 
                  onClick={() => setActiveTab('kisi')}
                  className={`w-full flex items-center justify-between px-4 py-3 rounded-lg text-sm font-medium transition-colors ${activeTab === 'kisi' ? 'bg-white text-teal-800 shadow-sm border border-teal-100 ring-1 ring-teal-200' : 'text-slate-600 hover:bg-white/50 hover:text-slate-900'}`}
                >
                  <span className="flex items-center gap-3">
                    <Table className="w-4 h-4" /> Kisi-kisi (6C)
                  </span>
                  <ChevronRight className={`w-4 h-4 transition-transform ${activeTab === 'kisi' ? 'rotate-90' : ''}`} />
                </button>
              </div>

              {/* Main Content Results */}
              <div className="lg:col-span-3 min-h-[500px]">
                
                {/* TAB: SOAL */}
                {activeTab === 'soal' && (
                  <div className="space-y-6 animate-in fade-in duration-300">
                    {generatedData.map((item) => (
                      <Card key={item.no} className="p-0 overflow-hidden border-l-4 border-l-teal-600">
                        <div className="bg-slate-50 px-6 py-3 border-b border-slate-100 flex justify-between items-center">
                          <span className="font-bold text-slate-700">Soal No. {item.no}</span>
                          <Badge 
                            type={item.difficulty.includes('L3') ? 'danger' : item.difficulty.includes('L2') ? 'warning' : 'success'}
                          >
                            {item.difficulty}
                          </Badge>
                        </div>
                        <div className="p-6">
                          {/* Stimulus Section */}
                          {item.content.stimulus && (
                            <div className="mb-4 p-4 bg-teal-50/50 border border-teal-100 rounded-lg text-sm text-slate-700 italic font-serif relative">
                              <div className="flex gap-2 mb-2 text-teal-700 text-[10px] not-italic font-sans uppercase font-bold tracking-wider items-center">
                                <ScrollText className="w-3 h-3" /> Stimulus
                              </div>
                              {item.content.stimulus}
                            </div>
                          )}

                          <div className="text-slate-900 font-medium text-base mb-4 leading-relaxed">
                            {item.content.question}
                          </div>
                          
                          {item.content.options && item.content.options.length > 0 && (
                            <div className="space-y-2 ml-1">
                              {item.content.options.map((opt, idx) => {
                                const cleanOpt = opt.replace(/^[A-E]\.\s*/i, '');
                                return (
                                  <div key={idx} className="flex items-start gap-3 text-sm text-slate-700 p-2 rounded-lg hover:bg-slate-50 border border-transparent hover:border-slate-100 transition-all">
                                    <div className="w-6 h-6 rounded-full bg-white border border-slate-300 flex items-center justify-center text-xs font-bold text-slate-500 shrink-0 mt-0.5 shadow-sm">
                                      {String.fromCharCode(65 + idx)}
                                    </div>
                                    <span className="pt-0.5">{cleanOpt}</span>
                                  </div>
                                )
                              })}
                            </div>
                          )}
                        </div>
                      </Card>
                    ))}
                  </div>
                )}

                {/* TAB: KUNCI */}
                {activeTab === 'kunci' && (
                  <Card className="overflow-hidden animate-in fade-in duration-300">
                    <div className="divide-y divide-slate-100">
                      {generatedData.map((item) => (
                        <div key={item.no} className="p-5 flex flex-col gap-3 hover:bg-slate-50">
                          <div className="flex items-center gap-3">
                            <div className="w-8 h-8 bg-teal-700 text-white rounded-lg flex items-center justify-center font-bold text-sm shrink-0">
                              {item.no}
                            </div>
                            <span className="text-xs font-medium px-2 py-0.5 bg-slate-100 text-slate-500 rounded border border-slate-200">
                              {item.difficulty}
                            </span>
                          </div>
                          <div>
                            <div className="text-sm font-bold text-slate-900 mb-1 flex items-center gap-2">
                              Kunci Jawaban: <span className="text-teal-800 bg-teal-50 px-2 rounded border border-teal-100">{item.key}</span>
                            </div>
                            <div className="mt-2 text-sm text-slate-600 bg-yellow-50 p-3 rounded-lg border border-yellow-100">
                              <strong className="text-yellow-800">Pembahasan:</strong><br/>
                              {item.explanation}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </Card>
                )}

                {/* TAB: KISI-KISI */}
                {activeTab === 'kisi' && (
                  <Card className="overflow-hidden animate-in fade-in duration-300">
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm text-left">
                        <thead className="bg-teal-50 text-teal-900 font-semibold border-b border-teal-100">
                          <tr>
                            <th className="px-4 py-3 w-12 text-center">No</th>
                            <th className="px-4 py-3 min-w-[200px]">Tujuan Pembelajaran</th>
                            <th className="px-4 py-3 min-w-[200px]">Indikator & Integrasi</th>
                            <th className="px-4 py-3 w-24 text-center">Level</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100">
                          {generatedData.map((item) => (
                            <tr key={item.no} className="hover:bg-slate-50">
                              <td className="px-4 py-3 text-center text-slate-500 font-medium">{item.no}</td>
                              <td className="px-4 py-3 text-slate-700 align-top text-xs">{item.grid.competency}</td>
                              <td className="px-4 py-3 text-slate-600 align-top text-xs">
                                <div className="mb-2">{item.grid.indicator}</div>
                                {item.grid.dimension && (
                                  <div className="flex items-center gap-1 text-[10px] text-teal-700 font-semibold bg-teal-50 px-2 py-1 rounded w-fit border border-teal-100">
                                    <Globe className="w-3 h-3" /> {item.grid.dimension}
                                  </div>
                                )}
                              </td>
                              <td className="px-4 py-3 align-top text-center">
                                <Badge type={item.difficulty.includes('L3') ? 'danger' : item.difficulty.includes('L2') ? 'warning' : 'success'}>
                                  {item.grid.cognitive}
                                </Badge>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </Card>
                )}

              </div>
            </div>
          </div>
        )}

      </main>
    </div>
  );
}